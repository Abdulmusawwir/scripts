#!/bin/bash
# -----------------------------------------------------------------------------
# This script is provided as a convenience for Level.io customers. We cannot 
# guarantee this will work in all environments. Please test before deploying
# to your production environment.  We welcome contribution to the scripts in 
# our community repo!
# -----------------------------------------------------------------------------
#
# -----------------------------------------------------------------------------
# Script Configuration
# -----------------------------------------------------------------------------
# Name: Linux Vulnerability - libwebp CVE-2023-41064
# Description: This script is designed to identify and verify the installation of 
# specific versions of the libwebp package on Linux systems.
# Language: Bash
# Timeout: 100
# Version: 1.0
#

# Detect the OS release name/version
OS_RELEASE=$(lsb_release -cs)
DESIRED_VERSION=""

# Assign the desired version based on OS release
case $OS_RELEASE in
    "jammy")  # Ubuntu 22.04
        DESIRED_VERSION="1.2.2-2ubuntu0.22.04.2"
        ;;
    "focal")  # Ubuntu 20.04
        DESIRED_VERSION="0.6.1-2ubuntu0.20.04.3"
        ;;
    "bookworm")  # Debian 12
        DESIRED_VERSION="1.2.4-0.2+deb12u1"
        ;;
    *)
        echo "OS not recognized or not supported."
        exit 1
        ;;
esac


# Search for libwebp installations using apt
LIBWEBP_VERSIONS=$(apt list --installed 2>/dev/null | grep libwebp | awk -F'/' '{print $2}' | awk '{print $2}')

# Check if the desired version is found and flag if others are found
FOUND_DESIRED=false
FOUND_OTHER=false

for version in $LIBWEBP_VERSIONS; do
    if [[ $version == $DESIRED_VERSION ]]; then
        FOUND_DESIRED=true
    else
        FOUND_OTHER=true
        echo "Different version of libwebp found: $version"
        exit 1
    fi
done

if [ "$FOUND_DESIRED" = true ]; then
    echo "Desired version of libwebp ($DESIRED_VERSION) for $OS_RELEASE is installed."
    exit 0
fi

if [ "$FOUND_OTHER" = false ]; then
    echo "No other versions of libwebp found."
    exit 0
fi
